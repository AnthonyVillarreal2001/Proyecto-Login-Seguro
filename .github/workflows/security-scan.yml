name: Security Scan on Pull Requests

on:
  pull_request:
    branches: [ "dev", "test", "main" ]
    paths:
      - "**/*.py"
      - "**/*.java"
      - "**/*.js"
      - "**/*.c"
      - "**/*.cs"
  workflow_dispatch:

jobs:
  security-scan:
    name: Analyze Code Vulnerabilities
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt || true
        pip install joblib datasets scikit-learn==1.5.2 scipy requests pandas jq

    - name: List changed files
      id: files
      uses: tj-actions/changed-files@v39

    - name: Select code file to analyze
      id: pickfile
      run: |
        echo "Detecting modified source files..."
        for file in ${{ steps.files.outputs.all_changed_files }}; do
          if [[ $file == *.py || $file == *.java || $file == *.js || $file == *.c || $file == *.cs ]]; then
            echo "file_to_scan=$file" >> $GITHUB_OUTPUT
            exit 0
          fi
        done
        echo "file_to_scan=NONE" >> $GITHUB_OUTPUT

    - name: Stop if no analyzable file
      if: steps.pickfile.outputs.file_to_scan == 'NONE'
      run: |
        echo "No .py/.java/.js/.c/.cs file detected"
        exit 0

    - name: Run Security Check
      id: scan
      run: |
        RESULT=$(python scripts/security_check.py "${{ steps.pickfile.outputs.file_to_scan }}")
        echo "result=$RESULT" >> $GITHUB_OUTPUT
        echo "Security check result:"
        echo "$RESULT"

    - name: Parse result
      id: parse
      run: |
        echo '${{ steps.scan.outputs.result }}' > result.json
        STATUS=$(jq -r '.status' result.json)
        PROB=$(jq -r '.probability_vulnerable' result.json)
        LANG=$(jq -r '.language_detected' result.json)
        DANGER_FUNCS=$(jq -r '.dangerous_functions_found[]' result.json 2>/dev/null | tr '\n' ',' | sed 's/,$//')
        if [ -z "$DANGER_FUNCS" ]; then
          DANGER_FUNCS="None"
        fi
        
        echo "status=$STATUS" >> $GITHUB_OUTPUT
        echo "prob=$PROB" >> $GITHUB_OUTPUT
        echo "lang=$LANG" >> $GITHUB_OUTPUT
        echo "danger_funcs=$DANGER_FUNCS" >> $GITHUB_OUTPUT
        
        # Crear archivo de contenido para el issue
        cat > issue_body.md << EOF
        ## ðŸš¨ Vulnerabilidad Detectada en Pull Request
        
        Se detectÃ³ una vulnerabilidad en el archivo modificado:
        
        **ðŸ“„ Archivo:** \`${{ steps.pickfile.outputs.file_to_scan }}\`
        **ðŸ”¤ Lenguaje:** $LANG
        **âš ï¸ Estado:** $STATUS
        **ðŸ“Š Probabilidad de vulnerabilidad:** $(echo "$PROB * 100" | bc -l | xargs printf "%.2f")%
        **ðŸ”§ Funciones peligrosas detectadas:** $DANGER_FUNCS
        
        ### ðŸ“‹ Detalles del PR
        - **PR:** #${{ github.event.pull_request.number }}
        - **TÃ­tulo:** ${{ github.event.pull_request.title }}
        - **Autor:** ${{ github.event.pull_request.user.login }}
        - **Rama origen:** ${{ github.event.pull_request.head.ref }}
        - **Rama destino:** ${{ github.event.pull_request.base.ref }}
        
        ### ðŸ›¡ï¸ AcciÃ³n Requerida
        1. Revisar el archivo mencionado
        2. Corregir las funciones peligrosas detectadas
        3. Verificar que se implementen sanitizaciones adecuadas
        4. Re-ejecutar el escaneo de seguridad
        
        *Este merge fue bloqueado automÃ¡ticamente por el sistema de seguridad.*
        
        ---
        *ðŸ¤– Reporte generado automÃ¡ticamente por GitHub Actions*
        EOF

    - name: Notify Telegram
      if: always() && steps.pickfile.outputs.file_to_scan != 'NONE'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python scripts/telegram_notify.py "${{ steps.pickfile.outputs.file_to_scan }}" '${{ steps.scan.outputs.result }}'

    - name: Create issue if vulnerable
      if: steps.parse.outputs.status == 'VULNERABLE'
      uses: peter-evans/create-issue-from-file@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "ðŸš¨ Vulnerabilidad detectada en PR #${{ github.event.pull_request.number }} - ${{ steps.pickfile.outputs.file_to_scan }}"
        content-filepath: ./issue_body.md
        labels: |
          security
          vulnerability
          pr-review

    - name: Block merge if vulnerable
      if: steps.parse.outputs.status == 'VULNERABLE'
      run: |
        echo "âŒ Vulnerabilidad detectada. Bloqueando merge."
        exit 1

    - name: Approve if safe
      if: steps.parse.outputs.status == 'SAFE'
      run: |
        echo "âœ… CÃ³digo seguro. Merge permitido."
