name: ğŸ› ï¸ Setup CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'AcciÃ³n a realizar'
        required: true
        default: 'clean'
        type: choice
        options:
        - clean
        - test
        - all

jobs:
  setup:
    name: Setup Pipeline
    runs-on: ubuntu-latest
    
    steps:
    - name: Check current workflows
      run: |
        echo "ğŸ“ WORKFLOWS ACTUALES:"
        echo "======================"
        ls -la .github/workflows/ || echo "No hay workflows"
        
        echo ""
        echo "ğŸ§¹ Limpiando workflows antiguos..."
        rm -f .github/workflows/auto-merge*.yml 2>/dev/null || true
        rm -f .github/workflows/pipeline.yml 2>/dev/null || true
        
        echo "âœ… Limpieza completada"
    
    - name: Create necessary workflows
      run: |
        echo "ğŸ“‹ CREANDO WORKFLOWS NECESARIOS"
        echo "================================"
        
        echo "1. âœ… cicd-pipeline.yml (ya existe)"
        echo "2. âœ… auto-create-pr.yml (ya existe)"
        echo "3. âœ… setup-pipeline.yml (este archivo)"
        
        echo ""
        echo "ğŸ¯ ESTRUCTURA FINAL:"
        echo "==================="
        echo ".github/workflows/"
        echo "â”œâ”€â”€ cicd-pipeline.yml     # Pipeline principal"
        echo "â”œâ”€â”€ auto-create-pr.yml    # Crea PR automÃ¡tico"
        echo "â””â”€â”€ setup-pipeline.yml    # Este archivo"
    
    - name: Test pipeline structure
      run: |
        echo "ğŸ§ª TESTEANDO CONFIGURACIÃ“N"
        echo "=========================="
        
        # Verificar que los archivos existen
        if [ -f ".github/workflows/cicd-pipeline.yml" ]; then
          echo "âœ… cicd-pipeline.yml: OK"
          echo "   LÃ­neas: $(wc -l < .github/workflows/cicd-pipeline.yml)"
        else
          echo "âŒ cicd-pipeline.yml: NO ENCONTRADO"
        fi
        
        if [ -f ".github/workflows/auto-create-pr.yml" ]; then
          echo "âœ… auto-create-pr.yml: OK"
          echo "   LÃ­neas: $(wc -l < .github/workflows/auto-create-pr.yml)"
        else
          echo "âŒ auto-create-pr.yml: NO ENCONTRADO"
        fi
        
        echo ""
        echo "ğŸ“Š RESUMEN:"
        echo "==========="
        echo "Workflows configurados: $(ls .github/workflows/*.yml 2>/dev/null | wc -l)"
    
    - name: Send Telegram setup complete
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="ğŸ› ï¸ *ConfiguraciÃ³n CI/CD Completada*%0A%0Aâœ… *Estado:* CONFIGURADO%0AğŸ“ *Workflows:* 3 archivos%0AğŸš€ *Pipeline:* Listo%0AğŸ¤– *Auto-PR:* Activado%0A%0AÂ¡El sistema CI/CD estÃ¡ listo para usar!%0APush a la rama 'dev' para iniciar."
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"