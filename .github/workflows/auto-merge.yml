name: Auto-Merge Dev to Main

on:
  push:
    branches:
      - dev

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  security-check-all:
    name: Full Security Scan Before Merge
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt || true
        pip install joblib datasets scikit-learn==1.5.2 scipy requests pandas jq bc

    - name: Scan all files
      id: scan
      run: |
        echo "ğŸ” Iniciando escaneo de seguridad..."
        FAILED=0
        JS_COUNT=0
        JAVA_COUNT=0
        PY_COUNT=0
        VULNERABLE_FILES=""
        
        # JavaScript
        for file in $(find . -name "*.js" -not -path "*/node_modules/*" -not -path "*/.venv/*" -not -path "*/.next/*"); do
          JS_COUNT=$((JS_COUNT + 1))
          echo "ğŸ“„ Escaneando: $file"
          RESULT=$(python scripts/security_check.py "$file" 2>/dev/null || echo '{"status":"ERROR"}')
          STATUS=$(echo "$RESULT" | jq -r '.status')
          if [ "$STATUS" = "VULNERABLE" ]; then
            echo "âŒ VULNERABLE: $file"
            PROB=$(echo "$RESULT" | jq -r '.probability_vulnerable')
            LANG=$(echo "$RESULT" | jq -r '.language_detected')
            FUNCS=$(echo "$RESULT" | jq -r '.dangerous_functions_found[]?' 2>/dev/null | tr '\n' ';' | sed 's/;$//')
            if [ -z "$FUNCS" ]; then
              FUNCS="Unknown"
            fi
            VULNERABLE_FILES="${VULNERABLE_FILES}FILE:${file}|PROB:${PROB}|LANG:${LANG}|FUNCS:${FUNCS};"
            FAILED=1
          fi
        done
        
        # Java
        for file in $(find . -name "*.java" -not -path "*/node_modules/*" -not -path "*/.venv/*"); do
          JAVA_COUNT=$((JAVA_COUNT + 1))
          echo "ğŸ“„ Escaneando: $file"
          RESULT=$(python scripts/security_check.py "$file" 2>/dev/null || echo '{"status":"ERROR"}')
          STATUS=$(echo "$RESULT" | jq -r '.status')
          if [ "$STATUS" = "VULNERABLE" ]; then
            echo "âŒ VULNERABLE: $file"
            PROB=$(echo "$RESULT" | jq -r '.probability_vulnerable')
            LANG=$(echo "$RESULT" | jq -r '.language_detected')
            FUNCS=$(echo "$RESULT" | jq -r '.dangerous_functions_found[]?' 2>/dev/null | tr '\n' ';' | sed 's/;$//')
            if [ -z "$FUNCS" ]; then
              FUNCS="Unknown"
            fi
            VULNERABLE_FILES="${VULNERABLE_FILES}FILE:${file}|PROB:${PROB}|LANG:${LANG}|FUNCS:${FUNCS};"
            FAILED=1
          fi
        done
        
        # Python
        for file in $(find . -name "*.py" -not -path "*/node_modules/*" -not -path "*/.venv/*" -not -path "*/scripts/*" -not -path "*/.github/*"); do
          PY_COUNT=$((PY_COUNT + 1))
          echo "ğŸ“„ Escaneando: $file"
          RESULT=$(python scripts/security_check.py "$file" 2>/dev/null || echo '{"status":"ERROR"}')
          STATUS=$(echo "$RESULT" | jq -r '.status')
          if [ "$STATUS" = "VULNERABLE" ]; then
            echo "âŒ VULNERABLE: $file"
            PROB=$(echo "$RESULT" | jq -r '.probability_vulnerable')
            LANG=$(echo "$RESULT" | jq -r '.language_detected')
            FUNCS=$(echo "$RESULT" | jq -r '.dangerous_functions_found[]?' 2>/dev/null | tr '\n' ';' | sed 's/;$//')
            if [ -z "$FUNCS" ]; then
              FUNCS="Unknown"
            fi
            VULNERABLE_FILES="${VULNERABLE_FILES}FILE:${file}|PROB:${PROB}|LANG:${LANG}|FUNCS:${FUNCS};"
            FAILED=1
          fi
        done
        
        echo "js_count=$JS_COUNT" >> $GITHUB_OUTPUT
        echo "java_count=$JAVA_COUNT" >> $GITHUB_OUTPUT
        echo "py_count=$PY_COUNT" >> $GITHUB_OUTPUT
        echo "vulnerable_details=$VULNERABLE_FILES" >> $GITHUB_OUTPUT
        
        if [ $FAILED -eq 1 ]; then
          echo "âŒ Vulnerabilidades detectadas!"
          exit 1
        fi
        
        echo "âœ… Todos los archivos son seguros"

    - name: Send Telegram on failure
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        DETAILS="${{ steps.scan.outputs.vulnerable_details }}"
        
        # Construir mensaje detallado
        MESSAGE="ğŸš¨ *Auto-Merge BLOQUEADO*%0A%0AâŒ *Estado:* VULNERABLE%0AğŸ“‚ *Rama:* dev â†’ main%0AğŸš« *AcciÃ³n:* Merge bloqueado%0A%0A*ğŸ” Archivos Vulnerables:*%0A"
        
        # Parsear detalles de archivos vulnerables
        IFS=';' read -ra FILES <<< "$DETAILS"
        for item in "${FILES[@]}"; do
          if [ ! -z "$item" ]; then
            FILE=$(echo "$item" | grep -oP 'FILE:\K[^|]+')
            PROB=$(echo "$item" | grep -oP 'PROB:\K[^|]+')
            LANG=$(echo "$item" | grep -oP 'LANG:\K[^|]+')
            FUNCS=$(echo "$item" | grep -oP 'FUNCS:\K[^|]+')
            
            # Calcular porcentaje
            PERCENT=$(echo "$PROB * 100" | bc -l)
            PERCENT_FORMATTED=$(printf "%.2f" $PERCENT)
            
            MESSAGE="${MESSAGE}%0AğŸ“„ \`${FILE}\`%0AğŸ”¤ *Lenguaje:* ${LANG}%0Aâš ï¸ *Probabilidad:* ${PERCENT_FORMATTED}%%%0AğŸ”§ *Funciones:* ${FUNCS}%0A"
          fi
        done
        
        MESSAGE="${MESSAGE}%0Aâš ï¸ *Revisa GitHub Actions para mÃ¡s detalles*"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"

    - name: Create Issue on failure
      if: failure()
      run: |
        # Crear archivo de contenido para el issue
        cat > issue_body.md << EOF
        ## ğŸš¨ Auto-Merge Bloqueado: Vulnerabilidades Detectadas
        
        **Auto-merge bloqueado** debido a cÃ³digo vulnerable detectado en la rama \`dev\`.
        
        ### ğŸ“Š Archivos Vulnerables:
        
        EOF
        
        # Parsear detalles y agregar al archivo
        DETAILS="${{ steps.scan.outputs.vulnerable_details }}"
        IFS=';' read -ra FILES <<< "$DETAILS"
        for item in "${FILES[@]}"; do
          if [ ! -z "$item" ]; then
            FILE=$(echo "$item" | grep -oP 'FILE:\K[^|]+')
            PROB=$(echo "$item" | grep -oP 'PROB:\K[^|]+')
            LANG=$(echo "$item" | grep -oP 'LANG:\K[^|]+')
            FUNCS=$(echo "$item" | grep -oP 'FUNCS:\K[^|]+')
            
            PERCENT=$(echo "$PROB * 100" | bc -l)
            PERCENT_FORMATTED=$(printf "%.2f" $PERCENT)
            
            cat >> issue_body.md << EOF
        #### ğŸ“„ \`${FILE}\`
        - **Lenguaje:** ${LANG}
        - **Probabilidad de Vulnerabilidad:** ${PERCENT_FORMATTED}%
        - **Funciones Peligrosas:** ${FUNCS}
        
        EOF
          fi
        done
        
        cat >> issue_body.md << EOF
        ### ğŸ”§ AcciÃ³n Requerida:
        1. Revisar los archivos mencionados
        2. Corregir las vulnerabilidades detectadas
        3. Hacer commit de los cambios
        4. El auto-merge se ejecutarÃ¡ automÃ¡ticamente si el cÃ³digo es seguro
        
        **Commit:** ${{ github.sha }}
        **Rama:** dev
        **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        ---
        *ğŸ¤– Reporte generado automÃ¡ticamente por GitHub Actions*
        EOF

    - name: Create GitHub Issue
      if: failure()
      uses: peter-evans/create-issue-from-file@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "ğŸš¨ Auto-Merge Bloqueado: Vulnerabilidades Detectadas en Dev"
        content-filepath: ./issue_body.md
        labels: |
          security
          vulnerability
          auto-merge-blocked
          dev-branch

    - name: Send Telegram on success
      if: success()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="âœ… *Escaneo Completo*%0A%0Aâœ… *Estado:* SAFE%0AğŸ“‚ *Rama:* dev%0AğŸ“Š *Archivos:* JS=${{ steps.scan.outputs.js_count }} Java=${{ steps.scan.outputs.java_count }} Py=${{ steps.scan.outputs.py_count }}%0A%0AğŸ”„ *Mergeando a main*"
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" -d "chat_id=${TELEGRAM_CHAT_ID}" -d "text=${MESSAGE}" -d "parse_mode=Markdown"

  merge-to-main:
    name: Merge Dev to Main
    needs: security-check-all
    runs-on: ubuntu-latest
    if: success()

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"

    - name: Merge dev into main
      run: |
        git fetch origin main
        git checkout main
        git merge --no-ff origin/dev -m "ğŸ¤– Auto-merge dev to main after security checks passed"
        git push origin main

    - name: Success notification
      run: |
        echo "âœ… Successfully merged dev to main!"