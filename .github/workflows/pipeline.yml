name: Full CI/CD Pipeline

on:
  push:
    branches: [dev, test]
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  security-analysis:
    name: ğŸ” Security Analysis on Dev
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    
    outputs:
      is_safe: ${{ steps.scan.outputs.is_safe }}
      vulnerable_details: ${{ steps.scan.outputs.vulnerable_details }}
      scanned_files: ${{ steps.scan.outputs.scanned_files }}

    steps:
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: ğŸ“¥ Install Python dependencies
      run: |
        pip install -r requirements.txt || true
        pip install joblib datasets scikit-learn==1.5.2 scipy requests pandas

    - name: ğŸ” Security Scan All Files
      id: scan
      run: |
        echo "ğŸ”„ Iniciando escaneo de seguridad completo..."
        
        # Encontrar todos los archivos a analizar
        JS_FILES=$(find . -name "*.js" -not -path "*/node_modules/*" -not -path "*/.next/*" -not -path "*/.venv/*")
        PY_FILES=$(find . -name "*.py" -not -path "*/node_modules/*" -not -path "*/.venv/*" -not -path "*/scripts/*")
        JAVA_FILES=$(find . -name "*.java" -not -path "*/node_modules/*" -not -path "*/.venv/*")
        
        ALL_FILES="$JS_FILES $PY_FILES $JAVA_FILES"
        echo "ğŸ“‹ Archivos a analizar:"
        echo "$ALL_FILES" | while read file; do
          if [ -n "$file" ]; then
            echo "   - $file"
          fi
        done
        
        FAILED=0
        VULNERABLE_FILES=""
        SCANNED_COUNT=0
        FILE_LIST=""
        
        # Analizar cada archivo
        for file in $ALL_FILES; do
          if [ -f "$file" ]; then
            SCANNED_COUNT=$((SCANNED_COUNT + 1))
            FILE_LIST="${FILE_LIST}${file};"
            
            echo "ğŸ”¬ Analizando: $file"
            RESULT=$(python scripts/security_check.py "$file" 2>/dev/null || echo '{"status":"ERROR"}')
            STATUS=$(echo "$RESULT" | jq -r '.status' 2>/dev/null || echo "ERROR")
            
            if [ "$STATUS" = "VULNERABLE" ]; then
              echo "âŒ VULNERABLE: $file"
              PROB=$(echo "$RESULT" | jq -r '.probability' 2>/dev/null || echo "0")
              LANG=$(echo "$RESULT" | jq -r '.language' 2>/dev/null || echo "Unknown")
              FUNCS=$(echo "$RESULT" | jq -r '.dangerous_functions' 2>/dev/null || echo "[]")
              OWASP=$(echo "$RESULT" | jq -r '.owasp_category' 2>/dev/null || echo "Unknown")
              
              VULNERABLE_FILES="${VULNERABLE_FILES}FILE:${file}|PROB:${PROB}|LANG:${LANG}|FUNCS:${FUNCS}|OWASP:${OWASP};"
              FAILED=1
            elif [ "$STATUS" = "SAFE" ]; then
              echo "âœ… SAFE: $file"
            else
              echo "âš ï¸  ERROR analizando: $file"
            fi
          fi
        done
        
        echo "scanned_count=$SCANNED_COUNT" >> $GITHUB_OUTPUT
        echo "scanned_files=$FILE_LIST" >> $GITHUB_OUTPUT
        echo "vulnerable_details=$VULNERABLE_FILES" >> $GITHUB_OUTPUT
        
        if [ $FAILED -eq 1 ]; then
          echo "is_safe=false" >> $GITHUB_OUTPUT
          echo "âŒ Â¡Vulnerabilidades detectadas! Bloqueando merge..."
          exit 1
        else
          echo "is_safe=true" >> $GITHUB_OUTPUT
          echo "âœ… Â¡Todos los archivos son seguros! Procediendo..."
        fi

    - name: ğŸ“Š Report Scan Results
      run: |
        echo "ğŸ“ˆ RESUMEN DEL ESCANEO:"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "Archivos analizados: ${{ steps.scan.outputs.scanned_count }}"
        echo "Estado: ${{ steps.scan.outputs.is_safe == 'true' && 'âœ… SEGURO' || 'âŒ VULNERABLE' }}"
        
        if [ "${{ steps.scan.outputs.vulnerable_details }}" != "" ]; then
          echo ""
          echo "ğŸš¨ ARCHIVOS VULNERABLES:"
          echo "${{ steps.scan.outputs.vulnerable_details }}" | tr ';' '\n' | while read -r item; do
            if [ -n "$item" ]; then
              FILE=$(echo "$item" | grep -oP 'FILE:\K[^|]+')
              echo "   - $FILE"
            fi
          done
        fi

    - name: ğŸš¨ Send Telegram Alert on Failure
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        DETAILS="${{ steps.scan.outputs.vulnerable_details }}"
        
        MESSAGE="ğŸš¨ *Auto-Merge BLOQUEADO*%0A%0AâŒ *Estado:* VULNERABLE%0AğŸ“‚ *Rama:* dev â†’ test%0AğŸš« *AcciÃ³n:* Merge bloqueado%0A%0A*ğŸ” Resumen:*%0A"
        MESSAGE="${MESSAGE}ğŸ“Š Archivos analizados: ${{ steps.scan.outputs.scanned_count }}%0A"
        
        IFS=';' read -ra FILES <<< "$DETAILS"
        VULN_COUNT=0
        for item in "${FILES[@]}"; do
          if [ ! -z "$item" ]; then
            VULN_COUNT=$((VULN_COUNT + 1))
          fi
        done
        
        MESSAGE="${MESSAGE}âš ï¸ Vulnerables: ${VULN_COUNT}%0A%0A*ğŸ“‹ Detalles:*%0A"
        
        IFS=';' read -ra FILES <<< "$DETAILS"
        for item in "${FILES[@]}"; do
          if [ ! -z "$item" ]; then
            FILE=$(echo "$item" | grep -oP 'FILE:\K[^|]+')
            PROB=$(echo "$item" | grep -oP 'PROB:\K[^|]+')
            LANG=$(echo "$item" | grep -oP 'LANG:\K[^|]+')
            FUNCS=$(echo "$item" | grep -oP 'FUNCS:\K[^|]+')
            OWASP=$(echo "$item" | grep -oP 'OWASP:\K[^|]+')
            
            PERCENT=$(echo "$PROB * 100" | bc 2>/dev/null || echo "0")
            PERCENT_INT=$(printf "%.0f" $PERCENT 2>/dev/null || echo "0")
            
            MESSAGE="${MESSAGE}%0AğŸ“„ \`$(basename "$FILE")\`%0A"
            MESSAGE="${MESSAGE}   ğŸ”¤ ${LANG} | âš ï¸ ${PERCENT_INT}%%%0A"
            MESSAGE="${MESSAGE}   ğŸ›¡ï¸ ${OWASP}%0A"
          fi
        done
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"

    - name: âœ… Send Telegram Success Notification
      if: success()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="âœ… *Escaneo de Seguridad COMPLETADO*%0A%0AğŸ“‚ *Rama:* dev%0A"
        MESSAGE="${MESSAGE}ğŸ“Š *Archivos analizados:* ${{ steps.scan.outputs.scanned_count }}%0A"
        MESSAGE="${MESSAGE}ğŸ›¡ï¸ *Estado:* TODOS SEGUROS%0A%0A"
        MESSAGE="${MESSAGE}ğŸ”„ *Siguiente paso:* Mergeando a test para pruebas unitarias"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"

  merge-to-test:
    name: ğŸ”€ Merge Dev to Test
    needs: security-analysis
    runs-on: ubuntu-latest
    if: needs.security-analysis.outputs.is_safe == 'true' && github.ref == 'refs/heads/dev'

    steps:
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: âš™ï¸ Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"

    - name: ğŸ”€ Merge dev into test
      run: |
        echo "ğŸ”„ Mergeando dev a test..."
        git checkout test
        git pull origin test
        git merge --no-ff origin/dev -m "ğŸ”€ Auto-merge: dev â†’ test [Security Check Passed]
        
        âœ… Security Analysis Results:
        - Archivos analizados: ${{ needs.security-analysis.outputs.scanned_count }}
        - Estado: SEGURO
        - Vulnerabilidades: 0
        
        SHA: ${{ github.sha }}"
        git push origin test

    - name: ğŸ“¢ Notify Merge Success
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="âœ… *Merge Completado*%0A%0AğŸ”„ *De:* dev%0AğŸ“‚ *A:* test%0A"
        MESSAGE="${MESSAGE}ğŸ“Š *Archivos analizados:* ${{ needs.security-analysis.outputs.scanned_count }}%0A"
        MESSAGE="${MESSAGE}ğŸ›¡ï¸ *Estado:* TODOS SEGUROS%0A%0A"
        MESSAGE="${MESSAGE}ğŸ§ª *Siguiente paso:* Ejecutando pruebas unitarias en test"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"

  backend-tests:
    name: ğŸ§ª Backend Tests (Node.js)
    needs: merge-to-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/test'

    steps:
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v3

    - name: ğŸ“‚ Navegar a backend
      run: |
        echo "ğŸ“ Directorio actual:"
        ls -la
        echo "ğŸ“ Buscando backend..."
        if [ -d "backend" ]; then
          echo "âœ… Backend encontrado en /backend"
          cd backend
        elif [ -f "package.json" ] && [ -f "index.js" ] || [ -f "server.js" ] || [ -f "app.js" ]; then
          echo "âœ… Backend encontrado en raÃ­z"
        else
          echo "âŒ No se encontrÃ³ backend"
          exit 1
        fi

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¥ Install Backend Dependencies
      run: |
        echo "ğŸ“¦ Instalando dependencias del backend..."
        npm ci || npm install
        echo "âœ… Dependencias instaladas"

    - name: ğŸ§ª Run Backend Unit Tests
      id: backend-tests
      run: |
        echo "ğŸ§ª Ejecutando pruebas unitarias del backend..."
        
        # Verificar si hay scripts de test
        if grep -q '"test"' package.json; then
          echo "ğŸ“‹ Scripts disponibles en package.json:"
          npm run
          
          # Ejecutar pruebas
          echo "ğŸš€ Ejecutando npm test..."
          if npm test; then
            echo "âœ… Backend tests PASSED"
            echo "backend_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Backend tests FAILED"
            echo "backend_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "âš ï¸ No se encontrÃ³ script 'test' en package.json"
          echo "ğŸ” Buscando archivos de test..."
          
          # Buscar archivos de test
          TEST_FILES=$(find . -name "*.test.js" -o -name "*.spec.js" -o -name "test*.js" | head -5)
          if [ -n "$TEST_FILES" ]; then
            echo "ğŸ“„ Archivos de test encontrados:"
            echo "$TEST_FILES"
            echo "ğŸš€ Ejecutando tests con Jest/Mocha..."
            
            # Intentar con Jest
            if npx jest --passWithNoTests 2>/dev/null; then
              echo "âœ… Tests ejecutados con Jest"
              echo "backend_passed=true" >> $GITHUB_OUTPUT
            elif npx mocha "**/*.test.js" --exit 2>/dev/null; then
              echo "âœ… Tests ejecutados con Mocha"
              echo "backend_passed=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ No se pudo ejecutar tests"
              echo "backend_passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "âš ï¸ No se encontraron archivos de test"
            echo "backend_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Saltando tests (ninguno encontrado)"
          fi
        fi

    - name: ğŸ“Š Report Test Coverage
      if: always()
      run: |
        echo "ğŸ“ˆ RESUMEN DE PRUEBAS BACKEND:"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "Estado: ${{ steps.backend-tests.outputs.backend_passed == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}"
        echo "Directorio: $(pwd)"
        
        # Mostrar estructura de tests si existe
        if [ -d "test" ] || [ -d "__tests__" ] || [ -d "tests" ]; then
          echo "ğŸ“ Estructura de tests:"
          find . -type d -name "*test*" | while read dir; do
            echo "   - $dir"
          done
        fi

  frontend-tests:
    name: ğŸ§ª Frontend Tests (React)
    needs: merge-to-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/test'

    steps:
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v3

    - name: ğŸ“‚ Navegar a frontend
      run: |
        echo "ğŸ“ Directorio actual:"
        ls -la
        echo "ğŸ“ Buscando frontend..."
        if [ -d "frontend" ]; then
          echo "âœ… Frontend encontrado en /frontend"
          cd frontend
        elif [ -d "client" ]; then
          echo "âœ… Frontend encontrado en /client"
          cd client
        elif [ -f "package.json" ] && grep -q "react-scripts" package.json; then
          echo "âœ… Frontend encontrado en raÃ­z"
        else
          echo "âš ï¸ No se encontrÃ³ frontend React"
          echo "frontend_found=false" >> $GITHUB_ENV
          exit 0
        fi
        echo "frontend_found=true" >> $GITHUB_ENV

    - name: ğŸŸ¢ Setup Node.js
      if: env.frontend_found == 'true'
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¥ Install Frontend Dependencies
      if: env.frontend_found == 'true'
      run: |
        echo "ğŸ“¦ Instalando dependencias del frontend..."
        npm ci || npm install
        echo "âœ… Dependencias instaladas"

    - name: ğŸ§ª Run Frontend Tests
      if: env.frontend_found == 'true'
      id: frontend-tests
      run: |
        echo "ğŸ§ª Ejecutando pruebas del frontend..."
        
        # Verificar scripts de test
        if grep -q '"test"' package.json; then
          echo "ğŸš€ Ejecutando npm test (modo CI)..."
          
          # Configurar para modo CI (sin interactividad)
          export CI=true
          
          if npm test -- --watchAll=false --passWithNoTests; then
            echo "âœ… Frontend tests PASSED"
            echo "frontend_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Frontend tests FAILED"
            echo "frontend_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "âš ï¸ No hay script 'test' en package.json"
          echo "frontend_passed=true" >> $GITHUB_OUTPUT
          echo "âœ… Saltando tests frontend"
        fi

    - name: ğŸ“ Frontend Test Summary
      if: always() && env.frontend_found == 'true'
      run: |
        echo "ğŸ“ˆ RESUMEN DE PRUEBAS FRONTEND:"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "Estado: ${{ steps.frontend-tests.outputs.frontend_passed == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}"
        echo "Framework: React"
        echo "Directorio: $(pwd)"

  merge-to-main:
    name: ğŸš€ Merge Test to Main
    needs: [backend-tests, frontend-tests]
    runs-on: ubuntu-latest
    if: |
      (needs.backend-tests.outputs.backend_passed == 'true' || needs.backend-tests.result == 'skipped') &&
      (needs.frontend-tests.outputs.frontend_passed == 'true' || needs.frontend-tests.result == 'skipped') &&
      github.ref == 'refs/heads/test'

    steps:
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: âš™ï¸ Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"

    - name: ğŸ”€ Merge test into main
      run: |
        echo "ğŸš€ Mergeando test a main..."
        
        # Obtener commits desde el Ãºltimo merge
        LAST_MERGE=$(git log --oneline --grep="Auto-merge" -1 --format="%H" 2>/dev/null || echo "")
        
        git checkout main
        git pull origin main
        
        MERGE_MESSAGE="ğŸš€ Auto-merge: test â†’ main [All Checks Passed]
        
        ğŸ“Š RESULTADOS DE CI/CD:
        
        ğŸ” Security Analysis:
        - Archivos analizados: ${{ needs.security-analysis.outputs.scanned_count }}
        - Vulnerabilidades: 0
        - Estado: âœ… SEGURO
        
        ğŸ§ª Pruebas Unitarias:
        - Backend: ${{ needs.backend-tests.outputs.backend_passed == 'true' && 'âœ… PASSED' || 'âš ï¸ SKIPPED' }}
        - Frontend: ${{ needs.frontend-tests.outputs.frontend_passed == 'true' && 'âœ… PASSED' || 'âš ï¸ SKIPPED' }}
        
        ğŸ“¦ Despliegue:
        - Rama origen: test
        - Rama destino: main
        - Commit: ${{ github.sha }}
        
        ğŸ·ï¸ Tags: ci-cd, auto-deploy, security-verified"
        
        git merge --no-ff origin/test -m "$MERGE_MESSAGE"
        git push origin main
        
        # Crear tag de release
        DATE_TAG=$(date +'%Y%m%d-%H%M%S')
        git tag -a "release-$DATE_TAG" -m "Release $DATE_TAG - CI/CD Pipeline Success"
        git push origin "release-$DATE_TAG"

    - name: ğŸ‰ Deploy Notification
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="ğŸ‰ *Â¡DESPLIEGUE EXITOSO!*%0A%0A"
        MESSAGE="${MESSAGE}ğŸš€ *Pipeline CI/CD COMPLETADO*%0A"
        MESSAGE="${MESSAGE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€%0A"
        MESSAGE="${MESSAGE}ğŸ“Š *Resumen:*%0A"
        MESSAGE="${MESSAGE}ğŸ” *Security Analysis:* âœ…%0A"
        MESSAGE="${MESSAGE}   - Archivos: ${{ needs.security-analysis.outputs.scanned_count }}%0A"
        MESSAGE="${MESSAGE}   - Vulnerabilidades: 0%0A"
        MESSAGE="${MESSAGE}ğŸ§ª *Pruebas Unitarias:*%0A"
        MESSAGE="${MESSAGE}   - Backend: ${{ needs.backend-tests.outputs.backend_passed == 'true' && 'âœ… PASSED' || 'âš ï¸ SKIPPED' }}%0A"
        MESSAGE="${MESSAGE}   - Frontend: ${{ needs.frontend-tests.outputs.frontend_passed == 'true' && 'âœ… PASSED' || 'âš ï¸ SKIPPED' }}%0A"
        MESSAGE="${MESSAGE}ğŸ“¦ *Despliegue:*%0A"
        MESSAGE="${MESSAGE}   - De: test%0A"
        MESSAGE="${MESSAGE}   - A: main%0A"
        MESSAGE="${MESSAGE}   - Commit: ${GITHUB_SHA:0:7}%0A"
        MESSAGE="${MESSAGE}ğŸ·ï¸ *Tag:* release-$(date +'%Y%m%d-%H%M%S')%0A%0A"
        MESSAGE="${MESSAGE}âœ… *Â¡Todo listo para producciÃ³n!*"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"

  rollback-on-failure:
    name: ğŸ”„ Rollback on Failure
    runs-on: ubuntu-latest
    if: failure() && (github.ref == 'refs/heads/test' || github.ref == 'refs/heads/dev')
    needs: [security-analysis, backend-tests, frontend-tests]

    steps:
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: âš™ï¸ Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"

    - name: ğŸ”„ Create Rollback Issue
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const failedJob = '${{ github.job }}';
          const failedStep = context.payload.action;
          const branch = '${{ github.ref }}'.replace('refs/heads/', '');
          
          let issueBody = `## ğŸ”„ Pipeline Fallido - Rollback Requerido\n\n`;
          issueBody += `**Rama:** ${branch}\n`;
          issueBody += `**Commit:** ${context.sha}\n`;
          issueBody += `**Trabajo fallido:** ${failedJob}\n\n`;
          
          issueBody += `### ğŸ“Š Estado de Jobs:\n`;
          issueBody += `- ğŸ” Security Analysis: ${'${{ needs.security-analysis.result }}'}\n`;
          issueBody += `- ğŸ§ª Backend Tests: ${'${{ needs.backend-tests.result }}'}\n`;
          issueBody += `- ğŸ§ª Frontend Tests: ${'${{ needs.frontend-tests.result }}'}\n\n`;
          
          issueBody += `### ğŸ”§ Acciones requeridas:\n`;
          issueBody += `1. Revisar logs del job fallido\n`;
          issueBody += `2. Corregir el problema\n`;
          issueBody += `3. Hacer push a la rama ${branch}\n`;
          issueBody += `4. El pipeline se reiniciarÃ¡ automÃ¡ticamente\n\n`;
          
          issueBody += `### ğŸ“ Detalles del error:\n`;
          issueBody += `Consulta los logs en: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ Pipeline Fallido en ${branch}`,
            body: issueBody,
            labels: ['pipeline-failed', 'needs-fix', branch]
          });

    - name: ğŸ“¢ Send Rollback Alert
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="ğŸš¨ *PIPELINE FALLIDO*%0A%0A"
        MESSAGE="${MESSAGE}âŒ *Estado:* FALLIDO%0A"
        MESSAGE="${MESSAGE}ğŸ“‚ *Rama:* ${{ github.ref_name }}%0A"
        MESSAGE="${MESSAGE}ğŸ”§ *Job fallido:* ${{ github.job }}%0A%0A"
        MESSAGE="${MESSAGE}ğŸ“Š *Estado de jobs:*%0A"
        MESSAGE="${MESSAGE}ğŸ” Security: ${{ needs.security-analysis.result }}%0A"
        MESSAGE="${MESSAGE}ğŸ§ª Backend: ${{ needs.backend-tests.result }}%0A"
        MESSAGE="${MESSAGE}ğŸ§ª Frontend: ${{ needs.frontend-tests.result }}%0A%0A"
        MESSAGE="${MESSAGE}âš ï¸ *Se ha creado un issue para tracking*%0A"
        MESSAGE="${MESSAGE}ğŸ”„ *Revisa GitHub para mÃ¡s detalles*"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"