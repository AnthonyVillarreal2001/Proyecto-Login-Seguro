name: Full CI/CD Pipeline (dev â†’ test â†’ main)

on:
  pull_request:
    branches: [test]
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  statuses: write

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  # ETAPA 1: RevisiÃ³n de Seguridad con ML
  security-review:
    name: Security Review with ML Model
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'test' && github.event.pull_request.head.ref == 'dev'
    
    outputs:
      security_status: ${{ steps.check_security.outputs.status }}
      security_details: ${{ steps.check_security.outputs.details }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v39
      with:
        files: |
          **/*.py
          **/*.js
          **/*.java
          **/*.c
          **/*.cs
    
    - name: Send Telegram - Inicio revisiÃ³n
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="ğŸ” *Inicio de RevisiÃ³n de Seguridad*%0A%0AğŸ“ *PR:* #${{ github.event.pull_request.number }}%0AğŸ“‚ *De:* ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}%0AğŸ‘¤ *Autor:* ${{ github.event.pull_request.user.login }}%0AğŸ“„ *Archivos modificados:* ${{ steps.changed-files.outputs.all_changed_files_count }}"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt || true
        pip install joblib datasets scikit-learn==1.5.2 scipy requests pandas jq
    
    - name: Run security check on changed files
      id: check_security
      run: |
        echo "ğŸ” Analizando archivos modificados..."
        VULNERABLE_COUNT=0
        VULNERABLE_DETAILS=""
        ALL_FILES="${{ steps.changed-files.outputs.all_changed_files }}"
        
        if [ -z "$ALL_FILES" ]; then
          echo "status=SAFE" >> $GITHUB_OUTPUT
          echo "details=No hay archivos analizables" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        IFS=' ' read -ra FILES <<< "$ALL_FILES"
        for file in "${FILES[@]}"; do
          if [[ $file == *.py || $file == *.js || $file == *.java || $file == *.c || $file == *.cs ]]; then
            echo "ğŸ“„ Analizando: $file"
            
            if [ -f "$file" ]; then
              RESULT=$(python scripts/security_check.py "$file" 2>/dev/null || echo '{"status":"ERROR"}')
              STATUS=$(echo "$RESULT" | jq -r '.status' 2>/dev/null || echo "ERROR")
              
              if [ "$STATUS" = "VULNERABLE" ]; then
                VULNERABLE_COUNT=$((VULNERABLE_COUNT + 1))
                PROB=$(echo "$RESULT" | jq -r '.probability' 2>/dev/null || echo "0")
                LANG=$(echo "$RESULT" | jq -r '.language' 2>/dev/null || echo "unknown")
                FUNCS=$(echo "$RESULT" | jq -r '.dangerous_functions' 2>/dev/null || echo "unknown")
                OWASP=$(echo "$RESULT" | jq -r '.owasp_category' 2>/dev/null || echo "Unknown")
                
                VULNERABLE_DETAILS="${VULNERABLE_DETAILS}FILE:${file}|PROB:${PROB}|LANG:${LANG}|FUNCS:${FUNCS}|OWASP:${OWASP};"
                
                echo "âŒ Vulnerable: $file"
              else
                echo "âœ… Safe: $file"
              fi
            fi
          fi
        done
        
        if [ $VULNERABLE_COUNT -gt 0 ]; then
          echo "status=VULNERABLE" >> $GITHUB_OUTPUT
          echo "details=$VULNERABLE_DETAILS" >> $GITHUB_OUTPUT
          echo "âŒ Se encontraron $VULNERABLE_COUNT archivos vulnerables"
          exit 1
        else
          echo "status=SAFE" >> $GITHUB_OUTPUT
          echo "details=All files are safe" >> $GITHUB_OUTPUT
          echo "âœ… Todos los archivos son seguros"
        fi
    
    - name: Send Telegram - Resultado seguridad (SAFE)
      if: success()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="âœ… *Resultado de Seguridad*%0A%0AğŸŸ¢ *Estado:* SEGURO%0AğŸ“ *PR:* #${{ github.event.pull_request.number }}%0AğŸ“„ *Archivos analizados:* ${{ steps.changed-files.outputs.all_changed_files_count }}%0AğŸ‘¤ *Autor:* ${{ github.event.pull_request.user.login }}%0A%0Aâœ… *Continuando con el pipeline...*"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"
    
    - name: Send Telegram - Resultado seguridad (VULNERABLE)
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        DETAILS="${{ steps.check_security.outputs.security_details }}"
        
        MESSAGE="ğŸš¨ *Resultado de Seguridad*%0A%0AğŸ”´ *Estado:* VULNERABLE%0AğŸ“ *PR:* #${{ github.event.pull_request.number }}%0AâŒ *Merge:* BLOQUEADO%0A%0A*Archivos vulnerables:*%0A"
        
        IFS=';' read -ra VULN_FILES <<< "$DETAILS"
        for item in "${VULN_FILES[@]}"; do
          if [ ! -z "$item" ]; then
            FILE=$(echo "$item" | grep -oP 'FILE:\K[^|]+')
            PROB=$(echo "$item" | grep -oP 'PROB:\K[^|]+')
            LANG=$(echo "$item" | grep -oP 'LANG:\K[^|]+')
            FUNCS=$(echo "$item" | grep -oP 'FUNCS:\K[^|]+')
            OWASP=$(echo "$item" | grep -oP 'OWASP:\K[^|]+')
            
            PERCENT=$(echo "$PROB * 100" | bc -l)
            PERCENT_FORMATTED=$(printf "%.2f" $PERCENT)
            
            MESSAGE="${MESSAGE}%0AğŸ“„ \`${FILE}\`%0AğŸ”¤ *Lenguaje:* ${LANG}%0Aâš ï¸ *Probabilidad:* ${PERCENT_FORMATTED}%%%0AğŸ›¡ï¸ *OWASP:* ${OWASP}%0AğŸ”§ *Funciones:* ${FUNCS}%0A"
          fi
        done
        
        MESSAGE="${MESSAGE}%0Aâš ï¸ *AcciÃ³n requerida:* Corregir vulnerabilidades antes de merge"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"
    
    - name: Create issue for vulnerabilities
      if: failure()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const details = '${{ steps.check_security.outputs.security_details }}';
          const vulnFiles = details.split(';').filter(f => f.length > 0);
          
          let issueBody = `## ğŸš¨ Vulnerabilidades Detectadas en PR #${{ github.event.pull_request.number }}\n\n`;
          issueBody += `**PR bloqueado** debido a cÃ³digo vulnerable detectado.\n\n`;
          issueBody += `**Autor:** ${{ github.event.pull_request.user.login }}\n`;
          issueBody += `**Rama:** ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}\n\n`;
          
          issueBody += '### ğŸ“Š Archivos Vulnerables:\n\n';
          
          vulnFiles.forEach(item => {
            const match = item.match(/FILE:([^|]+)\|PROB:([^|]+)\|LANG:([^|]+)\|FUNCS:([^|]+)\|OWASP:([^|]+)/);
            if (match) {
              const [_, file, prob, lang, funcs, owasp] = match;
              const percent = (parseFloat(prob) * 100).toFixed(2);
              
              issueBody += `#### ğŸ“„ \`${file}\`\n`;
              issueBody += `- **Lenguaje:** ${lang}\n`;
              issueBody += `- **Probabilidad de Vulnerabilidad:** ${percent}%\n`;
              issueBody += `- **CategorÃ­a OWASP:** ${owasp}\n`;
              issueBody += `- **Funciones Peligrosas:** ${funcs}\n\n`;
            }
          });
          
          issueBody += '### ğŸ”§ AcciÃ³n Requerida:\n';
          issueBody += '1. Revisar los archivos vulnerables\n';
          issueBody += '2. Corregir las vulnerabilidades detectadas\n';
          issueBody += '3. Actualizar el PR con los cambios\n';
          issueBody += '4. El pipeline se ejecutarÃ¡ automÃ¡ticamente\n\n';
          issueBody += '---\n';
          issueBody += '*ğŸ¤– Issue generada automÃ¡ticamente por el sistema de seguridad*';
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ PR #${{ github.event.pull_request.number }} Bloqueado: Vulnerabilidades Detectadas`,
            body: issueBody,
            labels: ['security', 'vulnerability', 'fixing-required', 'pr-blocked']
          });
    
    - name: Add label "fixing-required"
      if: failure()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ github.event.pull_request.number }},
            labels: ['fixing-required']
          });

  # ETAPA 2: Merge automÃ¡tico a test + Pruebas unitarias
  merge-and-test:
    name: Merge to Test & Run Tests
    runs-on: ubuntu-latest
    needs: security-review
    if: needs.security-review.outputs.security_status == 'SAFE'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
    
    - name: Merge dev into test
      id: merge_test
      run: |
        # Obtener detalles del PR
        PR_NUMBER=${{ github.event.pull_request.number }}
        HEAD_SHA=${{ github.event.pull_request.head.sha }}
        BASE_SHA=${{ github.event.pull_request.base.sha }}
        
        echo "ğŸ”„ Merging dev into test..."
        
        # Fetch todas las ramas
        git fetch origin dev
        git fetch origin test
        
        # Hacer checkout a test
        git checkout test
        
        # Merge
        git merge --no-ff origin/dev -m "ğŸ¤– Auto-merge from dev to test (PR #$PR_NUMBER)"
        
        # Push
        git push origin test
        
        echo "âœ… Merge completado"
        echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
    
    - name: Send Telegram - Merge a test
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="ğŸ”„ *Merge a Test Realizado*%0A%0Aâœ… *Estado:* EXITOSO%0AğŸ“ *PR:* #${{ github.event.pull_request.number }}%0AğŸ“‚ *De:* dev â†’ test%0AğŸ”— *Commit:* \`${{ steps.merge_test.outputs.sha }}\`%0A%0Aâš™ï¸ *Ejecutando pruebas...*"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"
    
    - name: Run backend tests
      working-directory: ./backend
      run: |
        echo "ğŸ§ª Ejecutando pruebas del backend..."
        npm test 2>&1 | tee test-output.log
        
        # Verificar resultado
        if grep -q "FAIL" test-output.log || grep -q "Test Suites:.*failed" test-output.log; then
          echo "âŒ Pruebas fallaron"
          exit 1
        fi
        
        echo "âœ… Pruebas pasaron"
    
    - name: Send Telegram - Resultado pruebas (Ã‰xito)
      if: success()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="âœ… *Resultado de Pruebas*%0A%0AğŸŸ¢ *Estado:* TODAS PASARON%0AğŸ“ *PR:* #${{ github.event.pull_request.number }}%0AğŸ“‚ *Rama:* test%0A%0AğŸš€ *Continuando a producciÃ³n...*"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"
    
    - name: Send Telegram - Resultado pruebas (Fallidas)
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="âŒ *Resultado de Pruebas*%0A%0AğŸ”´ *Estado:* FALLIDAS%0AğŸ“ *PR:* #${{ github.event.pull_request.number }}%0AğŸ“‚ *Rama:* test%0AğŸš« *Merge a main:* BLOQUEADO%0A%0Aâš ï¸ *Revisa los logs de GitHub Actions*"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"
    
    - name: Add label "tests-failed"
      if: failure()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ github.event.pull_request.number }},
            labels: ['tests-failed']
          });

  # ETAPA 3: Merge a main
  merge-to-main:
    name: Merge to Main (Production)
    runs-on: ubuntu-latest
    needs: [security-review, merge-and-test]
    if: |
      needs.security-review.outputs.security_status == 'SAFE' &&
      needs.merge-and-test.result == 'success'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
    
    - name: Create PR test â†’ main
      id: create_pr
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const pr = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: "ğŸš€ Deploy to Production [Automated]",
            body: "Este PR fue creado automÃ¡ticamente despuÃ©s de pasar todas las validaciones:\n\n" +
                  "âœ… RevisiÃ³n de seguridad con ML\n" +
                  "âœ… Pruebas unitarias e integraciÃ³n\n\n" +
                  "**Detalles:**\n" +
                  `- PR original: #${context.payload.pull_request.number}\n` +
                  `- Commit: ${context.payload.pull_request.head.sha}\n` +
                  `- Autor: ${context.payload.pull_request.user.login}\n\n` +
                  "Este merge desplegarÃ¡ automÃ¡ticamente en producciÃ³n.",
            head: "test",
            base: "main"
          });
          
          console.log(`PR creado: #${pr.data.number}`);
          
          // Auto-merge el PR
          await github.rest.pulls.merge({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pr.data.number,
            merge_method: "merge"
          });
          
          return pr.data.number;
    
    - name: Send Telegram - Despliegue exitoso
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="ğŸš€ *Despliegue en ProducciÃ³n*%0A%0Aâœ… *Estado:* EXITOSO%0AğŸ“ *PR Original:* #${{ github.event.pull_request.number }}%0AğŸ“‚ *Rama:* test â†’ main%0AğŸ‘¤ *Autor:* ${{ github.event.pull_request.user.login }}%0A%0AğŸ‰ *Â¡AplicaciÃ³n desplegada en producciÃ³n!*"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"