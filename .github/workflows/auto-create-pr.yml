name: ğŸ¤– Auto-Create PR (dev â†’ test)

on:
  push:
    branches: [dev]

jobs:
  create-pr:
    name: Create PR dev â†’ test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Get commit details
      id: commit-info
      run: |
        echo "ğŸ“Š INFORMACIÃ“N DEL COMMIT"
        echo "========================="
        echo "SHA: ${{ github.sha }}"
        echo "Autor: ${{ github.actor }}"
        echo "Mensaje:"
        git log -1 --pretty=format:"%s"
        echo ""
        echo "Archivos modificados:"
        git diff --name-only HEAD~1 HEAD || echo "No se pueden obtener cambios"
    
    - name: Create Pull Request
      id: create-pr
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "Auto-commit from dev branch"
        title: "ğŸ”„ [Auto-PR] dev â†’ test - ${{ github.sha }}"
        body: |
          ## ğŸ¤– Pull Request AutomÃ¡tico
          
          Este PR fue creado automÃ¡ticamente despuÃ©s de un push a la rama `dev`.
          
          ### ğŸ“‹ Detalles:
          - **Commit:** `${{ github.sha }}`
          - **Autor:** ${{ github.actor }}
          - **Fecha:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Mensaje:** $(git log -1 --pretty=format:"%s")
          
          ### ğŸ” Cambios incluidos:
          ```
          $(git diff --stat HEAD~1 HEAD 2>/dev/null || echo "No se pueden mostrar cambios")
          ```
          
          ### âš¡ PrÃ³ximos pasos:
          1. El pipeline CI/CD se ejecutarÃ¡ automÃ¡ticamente
          2. AnÃ¡lisis de seguridad con modelo ML
          3. EjecuciÃ³n de pruebas unitarias
          4. Merge automÃ¡tico si todo pasa
          
          ---
          *Generado automÃ¡ticamente por GitHub Actions*
        base: test
        branch: auto-pr-dev-to-test-${{ github.run_id }}
        delete-branch: true
        labels: |
          automated
          ci-cd
          dev-to-test
        assignees: ${{ github.actor }}
    
    - name: Send Telegram notification
      if: steps.create-pr.outputs.pull-request-number != ''
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="ğŸ”„ *PR AutomÃ¡tico Creado*%0A%0AğŸ“ *PR:* #${{ steps.create-pr.outputs.pull-request-number }}%0AğŸ“‚ *dev â†’ test*%0AğŸ‘¤ *Autor:* ${{ github.actor }}%0AğŸ”— *Commit:* \`${{ github.sha }}\`%0A%0Aâš¡ *El pipeline CI/CD se ejecutarÃ¡ en segundos...*"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"